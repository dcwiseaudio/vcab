<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WiseReader í€´ì¦ˆ</title>
  <style>
    :root{--brand:#4f8ef7;--bg:#f7f7fb;--card:#fff;--bd:#e9eef5;--tx:#222;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:10px 16px}
    .top{display:flex;flex-direction:column;gap:6px;align-items:center}
    .t1{margin:0;font-size:20px;font-weight:900}
    .t2{font-size:18px;font-weight:900;color:var(--brand);text-align:center}
    main{max-width:900px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    .q{font-size:22px;font-weight:900;text-align:center;margin:0 0 12px}
    .opt{display:block;width:100%;text-align:left;margin:8px 0;padding:12px;border:1px solid #d5ddea;border-radius:12px;background:#fafcff;font-weight:900;cursor:pointer}
    .opt.correct{background:#d9f8d7;border-color:#97e493}
    .opt.wrong{background:#fde1e1;border-color:#f2a5a5}
    .status{margin-top:10px;font-size:14px;font-weight:900;text-align:center;color:#555}
    .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:12px}
    button{padding:10px 12px;border-radius:10px;border:1px solid #d5ddea;background:#fff;font-weight:900;cursor:pointer}
    .err{margin-top:10px;color:#c62828;font-weight:900;text-align:center;white-space:pre-line;display:none}
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="t1">â“ ê°ê´€ì‹ í€´ì¦ˆ</div>
    <div id="bookLine" class="t2"></div>
  </div>
</header>

<main>
  <div class="card">
    <div id="err" class="err"></div>
    <div id="quizArea"></div>
    <div id="stat" class="status"></div>

    <div class="row">
      <button id="next" disabled>ë‹¤ìŒ â–¶</button>
      <button id="reset">ìƒˆ ì„¸íŠ¸ ğŸ”</button>
      <button onclick="location.href='menu.html'">ë©”ë‰´ë¡œ</button>
    </div>
  </div>
</main>

<script>
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vStNllzm5-k6fhgwTaSBEJBDPc2_18pBfSoltOuUunJKjPY-vmw75lWn2UFlRNY5uNVAMzrc3iiN-XD/pub?output=csv";

  const qn = sessionStorage.getItem('wr_qn') || '';
  const title = sessionStorage.getItem('wr_title') || '';
  if(!qn){ location.href='index.html'; }
  document.getElementById('bookLine').textContent = `${qn.toUpperCase()}  |  ${title}`;

  const errEl = document.getElementById('err');
  const quizArea = document.getElementById('quizArea');
  const statEl = document.getElementById('stat');
  const nextBtn = document.getElementById('next');
  const resetBtn = document.getElementById('reset');

  function showErr(t){ errEl.textContent=t; errEl.style.display='block'; }
  function hideErr(){ errEl.style.display='none'; errEl.textContent=''; }

  function parseCSV(text){
    const out=[];
    const lines=text.replace(/\ufeff/g,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
    for(const line of lines){
      if(!line.trim()) continue;
      const row=[];
      let cell='', inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i], nx=line[i+1];
        if(inQ){
          if(ch === '"' && nx === '"'){ cell+='"'; i++; }
          else if(ch === '"'){ inQ=false; }
          else cell+=ch;
        }else{
          if(ch === '"') inQ=true;
          else if(ch === ','){ row.push(cell); cell=''; }
          else cell+=ch;
        }
      }
      row.push(cell);
      out.push(row);
    }
    return out;
  }

  let setAll = [];      // {term, meaning}[]
  let remaining = [];
  let target = null;
  let answered = false;

  function shuffle(a){
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
  }

  async function loadSet(){
    hideErr();
    quizArea.innerHTML = "ë¡œë”© ì¤‘...";
    try{
      const r = await fetch(SHEET_CSV_URL, {cache:'no-store'});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const text = await r.text();
      const rows = parseCSV(text);

      // A:book_id, B:title, C:word, D:meaning
      const filtered = rows
        .filter(c => (c[0]||'').trim().toLowerCase() === qn && (c[2]||'').trim())
        .map(c => ({ term:(c[2]||'').trim(), meaning:(c[3]||'').trim() }));

      if(!filtered.length){
        throw new Error("í•´ë‹¹ QNìœ¼ë¡œ ë‹¨ì–´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      }
      setAll = filtered;
      resetSet();
    }catch(e){
      quizArea.innerHTML = "";
      showErr("í€´ì¦ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + e);
    }
  }

  function resetSet(){
    remaining = setAll.slice();
    nextBtn.disabled = true;
    nextQuiz();
  }

  function updateStat(){
    statEl.textContent = `ë‚¨ì€ ë‹¨ì–´: ${remaining.length} / ì „ì²´ ${setAll.length}`;
  }

  function nextQuiz(){
    quizArea.innerHTML = "";
    nextBtn.disabled = true;
    answered = false;

    if(remaining.length === 0){
      quizArea.innerHTML = "<h3 style='text-align:center'>ìˆ˜ê³ í–ˆì–´ìš”! ì™„ë£Œ ğŸ</h3>";
      updateStat();
      return;
    }

    target = remaining[Math.floor(Math.random()*remaining.length)];
    const wrongs = setAll.filter(w=>w!==target).map(w=>w.meaning);
    shuffle(wrongs);
    const opts = [target.meaning, ...wrongs.slice(0,3)];
    shuffle(opts);

    const q = document.createElement('div');
    q.className = 'q';
    q.textContent = `"${target.term}"ì˜ ëœ»ì€?`;
    quizArea.appendChild(q);

    opts.forEach(opt=>{
      const b = document.createElement('button');
      b.className = 'opt';
      b.textContent = opt;
      b.onclick = ()=>choose(b,opt);
      quizArea.appendChild(b);
    });

    updateStat();
  }

  function choose(btn,opt){
    if(answered) return;

    if(opt === target.meaning){
      btn.classList.add('correct');
      answered = true;
      remaining = remaining.filter(x=>x!==target);
      nextBtn.disabled = false;
      updateStat();
    }else{
      btn.classList.add('wrong');
      btn.disabled = true;
    }
  }

  nextBtn.addEventListener('click', nextQuiz);
  resetBtn.addEventListener('click', resetSet);

  loadSet();
</script>
</body>
</html>

