<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wisereader - Î∞úÏùåÎì£Í∏∞</title>
<style>
  :root { --brand:#4f8ef7; --bg:#f7f7fb; --card:#fff; --border:#e9eef5; --text:#222; }
  * { box-sizing:border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  header { position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:10px 16px; }
  .headbar { display:flex; flex-direction:column; align-items:center; gap:6px; }
  .appTitle { margin:0; font-size:26px; font-weight:800; text-align:center; }
  .bookTitle { font-size:20px; font-weight:800; color:var(--brand); min-height:1em; text-align:center; }
  main { max-width:980px; margin:0 auto; padding:20px; }
  .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.05); }
  .displayCard { font-size:26px; font-weight:800; text-align:center; padding:14px; border-radius:12px; background:#f0f5ff; border:1px solid #d9e4ff; }
  #subInfo { text-align:center; color:#555; margin-top:6px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px; justify-content:center; }
  button { padding:10px 14px; border-radius:10px; border:1px solid #d5ddea; background:#fff; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }
  .err { display:none; color:#c62828; margin-top:10px; font-weight:700; white-space:pre-line; text-align:center; }

  .overlay { position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:20; }
  .overlay.show { display:block; }
  .picker { position:fixed; inset:0; display:none; z-index:21; }
  .picker.show { display:flex; justify-content:center; align-items:center; }
  .picker-panel { width:90%; max-width:600px; max-height:80vh; background:#fff; border-radius:14px;
    box-shadow:0 12px 30px rgba(0,0,0,.2); display:flex; flex-direction:column; overflow:hidden; }
  .picker-header { padding:12px 16px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; }
  .picker-header h3 { margin:0; font-size:18px; }
  .picker-body { padding:8px 12px; overflow:auto; flex:1 1 auto; }
  .word-item { padding:8px 6px; border-bottom:1px solid #f1f4fa; display:flex; align-items:flex-start; gap:8px; }
  .word-check { margin-top:4px; }
  .word-main { flex:1; }
  .word-term { font-weight:700; font-size:15px; }
  .word-meaning { font-size:13px; color:#555; }
  .picker-footer { padding:10px 16px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;
    font-size:13px; color:#555; }
</style>
</head>
<body>
<header>
  <div class="headbar">
    <h1 class="appTitle">Wisereader Vocabulary Practice</h1>
    <div id="bookTitle" class="bookTitle"></div>
  </div>
</header>

<main>
  <div class="row" style="margin-bottom:12px;">
    <button onclick="backToMenu()">‚Üê Î©îÎâ¥</button>
    <button onclick="location.href='index.html'">QN Îã§Ïãú</button>
  </div>

  <section class="card">
    <h3 style="margin-top:0;">üîä Î∞úÏùåÎì£Í∏∞</h3>
    <div id="nowPlaying" class="displayCard">Î°úÎî© Ï§ë‚Ä¶</div>
    <div id="subInfo"></div>

    <div class="row">
      <button id="btnAll" onclick="playAll()">Ï†ÑÏ≤¥ Îì£Í∏∞ ‚ñ∂‚ñ∂</button>
      <button id="btnRepeat" onclick="openRepeatPicker()">ÏÑ†ÌÉù Î∞òÎ≥µ üîÅ</button>
      <button id="btnStop" onclick="stopSpeaking()">Ï†ïÏßÄ ‚èπ</button>
    </div>

    <div id="err" class="err"></div>
  </section>
</main>

<div id="overlay" class="overlay"></div>
<div id="repeatPicker" class="picker" aria-hidden="true">
  <div class="picker-panel">
    <div class="picker-header">
      <h3>Î∞òÎ≥µÌï† Îã®Ïñ¥ ÏÑ†ÌÉù (1‚Äì30Í∞ú)</h3>
      <div style="flex:1"></div>
      <button onclick="closeRepeatPicker()">Îã´Í∏∞ ‚úï</button>
    </div>
    <div class="picker-body" id="repeatList"></div>
    <div class="picker-footer">
      <span id="repeatCountLabel">ÏÑ†ÌÉù: 0Í∞ú</span>
      <div style="display:flex; gap:8px;">
        <button onclick="clearRepeatSelection()">Î™®Îëê Ìï¥Ï†ú</button>
        <button onclick="startRepeatFromSelection()">ÏÑ†ÌÉùÌïú Îã®Ïñ¥ Î∞òÎ≥µ ‚ñ∂</button>
      </div>
    </div>
  </div>
</div>

<script>
const SHEET_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vStNllzm5-k6fhgwTaSBEJBDPc2_18pBfSoltOuUunJKjPY-vmw75lWn2UFlRNY5uNVAMzrc3iiN-XD/pub?gid=0&single=true&output=csv";

function parseCSV(text) {
  const rows = [];
  const lines = text.replace(/\ufeff/g,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
  for (let line of lines) {
    if (!line.trim()) continue;
    const cells = [];
    let cell = '';
    let inQuotes = false;
    for (let i=0; i<line.length; i++) {
      const ch = line[i];
      const next = line[i+1];
      if (inQuotes) {
        if (ch === '"' && next === '"') { cell += '"'; i++; }
        else if (ch === '"') { inQuotes = false; }
        else { cell += ch; }
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ',') { cells.push(cell); cell=''; }
        else cell += ch;
      }
    }
    cells.push(cell);
    rows.push(cells);
  }
  return rows;
}

function getQN(){
  const p = new URLSearchParams(location.search);
  return (p.get('qn') || sessionStorage.getItem('wr_qn') || '').toLowerCase();
}

function showErr(msg){
  const el = document.getElementById('err');
  el.textContent = msg;
  el.style.display = 'block';
}

function backToMenu(){
  const qn = getQN();
  location.href = `menu.html?qn=${encodeURIComponent(qn)}`;
}

// ===== TTS =====
let preferredVoice = null;
let speechPrimed = false;
const VOICE_PRIORITY = [
  'Google US English','Google UK English Female','Google UK English Male',
  'Samantha','Karen','Daniel'
];

function pickBestVoice(){
  const voices = speechSynthesis.getVoices();
  const en = voices.filter(v => /^en(-|_)/i.test(v.lang));
  for (const name of VOICE_PRIORITY) {
    const found = en.find(v => v.name === name);
    if (found) return found;
  }
  return en[0] || voices[0] || null;
}
function ensureVoiceReady(){
  const tryPick = () => { preferredVoice = pickBestVoice(); };
  if (speechSynthesis.getVoices().length) tryPick();
  else speechSynthesis.onvoiceschanged = tryPick;
}
async function primeSpeechOnce(){
  if (speechPrimed) return;
  return new Promise(resolve=>{
    try{
      const u = new SpeechSynthesisUtterance(' ');
      u.lang='en-US'; u.volume=0.0;
      if (preferredVoice) u.voice = preferredVoice;
      u.onend=()=>{ speechPrimed=true; resolve(); };
      u.onerror=()=>{ speechPrimed=true; resolve(); };
      speechSynthesis.speak(u);
    }catch(_){ resolve(); }
  });
}
async function speakAsync(text, rate=0.8){
  try { speechSynthesis.cancel(); } catch(_) {}
  await new Promise(r=>setTimeout(r,120));
  await new Promise(resolve=>{
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang='en-US'; u.rate=rate;
      if (preferredVoice) u.voice = preferredVoice;
      u.onend=resolve; u.onerror=resolve;
      speechSynthesis.speak(u);
    }catch(_){ resolve(); }
  });
}
function stopSpeaking(){
  try { speechSynthesis.cancel(); } catch(_) {}
  mode='idle';
}

// ===== Data / UI =====
let todaySet = [];
let todayBookTitle = '';
let mode = 'idle';
let selectedRepeat = [];

function showWord(w, idx){
  document.getElementById('nowPlaying').textContent = `${w.term} ‚Äî ${w.meaning}`;
  document.getElementById('subInfo').textContent = `(${idx+1}/${todaySet.length})`;
}

async function loadSet(){
  const qn = getQN();
  if (!qn) { showErr('QNÏù¥ ÏóÜÏäµÎãàÎã§. indexÎ°ú ÎèåÏïÑÍ∞ÄÏÑ∏Ïöî.'); return false; }

  try{
    const res = await fetch(SHEET_CSV_URL, { cache:'no-store' });
    if(!res.ok) { showErr('CSV HTTP ' + res.status); return false; }
    const text = await res.text();
    if (text.startsWith('<!DOCTYPE html') || text.startsWith('<html')) {
      showErr("CSV ÎåÄÏã† HTMLÏù¥ Î∞òÌôòÎêòÏóàÏäµÎãàÎã§. Í≤åÏãú ÎßÅÌÅ¨ ÌôïÏù∏ ÌïÑÏöî");
      return false;
    }
    const rows = parseCSV(text);
    const data = rows
      .filter(cols => cols.length >= 4)
      .map(cols => ({
        book_id: (cols[0]||'').trim().toLowerCase(),
        book_title: (cols[1]||'').trim(),
        term: (cols[2]||'').trim(),
        meaning: (cols[3]||'').trim()
      }))
      .filter(r => r.book_id === qn && r.term);

    if(!data.length){ showErr('Ìï¥Îãπ QN Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'); return false; }

    todayBookTitle = data[0].book_title || qn.toUpperCase();
    document.getElementById('bookTitle').textContent = todayBookTitle;
    todaySet = data.map(r => ({ term:r.term, meaning:r.meaning }));

    sessionStorage.setItem('wr_qn', qn);
    sessionStorage.setItem('wr_title', todayBookTitle);

    showWord(todaySet[0], 0);
    ensureVoiceReady();
    return true;
  }catch(e){
    showErr('Ïò§Î•ò: ' + String(e));
    return false;
  }
}

// ===== Ï†ÑÏ≤¥ Îì£Í∏∞ =====
async function playAll(){
  if(!todaySet.length) return;
  stopSpeaking();
  ensureVoiceReady();
  await primeSpeechOnce();
  mode='all';
  for(let i=0;i<todaySet.length && mode==='all';i++){
    showWord(todaySet[i], i);
    await speakAsync(todaySet[i].term, 0.7);
    for(let t=0;t<10 && mode==='all';t++) await new Promise(r=>setTimeout(r,120));
  }
  mode='idle';
}

// ===== ÏÑ†ÌÉù Î∞òÎ≥µ =====
function openRepeatPicker(){
  if(!todaySet.length) return;
  renderRepeatList();
  document.getElementById('overlay').classList.add('show');
  document.getElementById('repeatPicker').classList.add('show');
}
function closeRepeatPicker(){
  document.getElementById('overlay').classList.remove('show');
  document.getElementById('repeatPicker').classList.remove('show');
}
function renderRepeatList(){
  const list = document.getElementById('repeatList');
  list.innerHTML = '';
  todaySet.forEach((w, idx)=>{
    const row = document.createElement('div');
    row.className='word-item';

    const checkbox = document.createElement('input');
    checkbox.type='checkbox';
    checkbox.className='word-check';
    checkbox.dataset.index=idx;
    checkbox.onchange=updateRepeatCount;

    const main = document.createElement('div');
    main.className='word-main';
    main.innerHTML = `<div class="word-term">${w.term}</div><div class="word-meaning">${w.meaning}</div>`;

    row.appendChild(checkbox);
    row.appendChild(main);
    list.appendChild(row);
  });
  updateRepeatCount();
}
function updateRepeatCount(){
  const checks = document.querySelectorAll('.word-check');
  let count=0;
  checks.forEach(c=>{ if(c.checked) count++; });
  document.getElementById('repeatCountLabel').textContent = `ÏÑ†ÌÉù: ${count}Í∞ú`;
}
function clearRepeatSelection(){
  document.querySelectorAll('.word-check').forEach(c=>c.checked=false);
  updateRepeatCount();
}
async function startRepeatFromSelection(){
  const checks = Array.from(document.querySelectorAll('.word-check'));
  const idxs = checks.filter(c=>c.checked).map(c=>parseInt(c.dataset.index,10));
  if(idxs.length===0){ alert('ÏµúÏÜå 1Í∞ú ÏÑ†ÌÉù'); return; }
  if(idxs.length>30){ alert('ÏµúÎåÄ 30Í∞ú'); return; }

  selectedRepeat = idxs.map(i=>todaySet[i]);
  closeRepeatPicker();

  stopSpeaking();
  ensureVoiceReady();
  await primeSpeechOnce();
  mode='repeat';

  while(mode==='repeat'){
    for(let i=0;i<selectedRepeat.length && mode==='repeat';i++){
      const w=selectedRepeat[i];
      const idx=todaySet.indexOf(w);
      showWord(w, idx>=0?idx:0);
      await speakAsync(w.term, 0.8);
      for(let t=0;t<10 && mode==='repeat';t++) await new Promise(r=>setTimeout(r,120));
    }
  }
}

loadSet();
</script>
</body>
</html>
