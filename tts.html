<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WiseReader 전체 듣기</title>
  <style>
    :root{--brand:#4f8ef7;--bg:#f7f7fb;--card:#fff;--bd:#e9eef5;--tx:#222;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:22px 16px}
    .top{display:flex;flex-direction:column;gap:10px;align-items:center}
    .t1{margin:0;font-size:30px;font-weight:900}
    .t2{font-size:26px;font-weight:900;color:var(--brand);text-align:center}

    main{max-width:900px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:12px}
    button{
      padding:12px 14px;border-radius:12px;border:1px solid #d5ddea;background:#fff;
      font-weight:900;cursor:pointer;min-width:120px
    }
    select{padding:10px 12px;border-radius:10px;border:1px solid #d5ddea;font-weight:900}
    audio{width:100%;margin-top:12px}
    .status{margin-top:10px;font-size:14px;font-weight:800;text-align:center;display:none}
    .bad{color:#c62828}

    /* ✅ 단어/뜻 박스 */
    .wordBox{
      margin-top:12px;
      background:#fff;
      border:1px solid var(--bd);
      border-radius:12px;
      padding:12px;
      max-height:38vh;
      overflow:auto;
    }
    .wordRow{
      display:flex;
      gap:10px;
      padding:8px 6px;
      border-bottom:1px solid #f1f4fa;
    }
    .wordTerm{font-weight:900; min-width:140px;}
    .wordMean{color:#444;}
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="t1">전체 듣기</div>
    <div id="bookLine" class="t2"></div>
  </div>
</header>

<main>
  <div class="card">
    <div class="row" style="margin-top:0">
      <button id="btnLoad">불러오기</button>
      <button id="btnPlay">재생</button>
      <button id="btnPause">일시정지</button>
      <button id="btnStop">정지</button>
    </div>

    <div class="row">
      <span style="font-weight:900;">속도</span>
      <select id="rate">
        <option value="0.9">0.9x</option>
        <option value="1.0" selected>1.0x</option>
        <option value="1.2">1.2x</option>
        <option value="1.5">1.5x</option>
      </select>

      <button id="m2">-2초</button>
      <button id="p2">+2초</button>
      <button id="restart">처음부터</button>
    </div>

    <audio id="player" controls preload="none"></audio>

    <!-- ✅ 단어/뜻 목록 -->
    <div id="wordBox" class="wordBox">단어목록 로딩중..</div>

    <div id="status" class="status bad"></div>

    <div class="row">
      <button onclick="location.href='index.html'">단어학습 초기메뉴</button>

      <a href="https://dcwiseaudio.github.io/wisereader-start/" target="_self"
         style="text-decoration:none; display:inline-block;">
        <button type="button">와이즈리더 시작 화면</button>
      </a>
    </div>
  </div>
</main>

<script>
  // ================== 세션 ==================
  const qn = (sessionStorage.getItem('wr_qn') || '').trim().toLowerCase();
  const title = (sessionStorage.getItem('wr_title') || '').trim();
  if(!qn){ location.href='index.html'; }

  document.getElementById('bookLine').textContent =
    `${qn.toUpperCase()}  |  ${title}`;

  const audio = document.getElementById('player');
  const rateSel = document.getElementById('rate');
  const statusEl = document.getElementById('status');

  function showError(msg){
    statusEl.textContent = msg;
    statusEl.style.display = 'block';
  }
  function clearError(){
    statusEl.textContent = '';
    statusEl.style.display = 'none';
  }

  // ================== 오디오: 온라인(GitHub)만 사용 ==================
  // ✅ 오디오 저장소 베이스 URL (확정)
  const AUDIO_BASE = "https://dcwiseaudio.github.io/audio";

  function audioUrl(){
    return `${AUDIO_BASE}/${qn}.mp3?v=${Date.now()}`;
  }

  async function tryLoadUrl(url, timeoutMs=4000){
    return await new Promise(resolve=>{
      const onCanPlay = ()=>cleanup(true);
      const onErr = ()=>cleanup(false);
      const t = setTimeout(()=>cleanup(false), timeoutMs);

      function cleanup(ok){
        clearTimeout(t);
        audio.removeEventListener('canplay', onCanPlay);
        audio.removeEventListener('error', onErr);
        resolve(ok);
      }

      audio.addEventListener('canplay', onCanPlay, {once:true});
      audio.addEventListener('error', onErr, {once:true});

      audio.src = url;
      audio.playbackRate = parseFloat(rateSel.value || "1.0");
      audio.load();
    });
  }

  async function load(){
    clearError();
    const url = audioUrl();

    const ok = await tryLoadUrl(url, 4500);
    if(!ok){
      showError(`mp3를 찾지 못했습니다: ${qn}.mp3`);
      return;
    }
  }

  function play(){
    clearError();
    if(!audio.src){ showError("먼저 불러오기를 누르세요."); return; }
    audio.playbackRate = parseFloat(rateSel.value || "1.0");
    audio.play().catch(()=>showError("재생이 차단되면 화면을 한번 터치 후 다시 재생하세요."));
  }

  function pause(){ audio.pause(); }
  function stop(){ audio.pause(); audio.currentTime=0; }

  function jump(sec){
    if(!audio.duration) return;
    audio.currentTime = Math.min(Math.max(0, audio.currentTime + sec), audio.duration);
  }

  document.getElementById('btnLoad').addEventListener('click', load);
  document.getElementById('btnPlay').addEventListener('click', play);
  document.getElementById('btnPause').addEventListener('click', pause);
  document.getElementById('btnStop').addEventListener('click', stop);

  rateSel.addEventListener('change', ()=>{
    audio.playbackRate = parseFloat(rateSel.value || "1.0");
  });

  document.getElementById('m2').addEventListener('click', ()=>jump(-2));
  document.getElementById('p2').addEventListener('click', ()=>jump(2));
  document.getElementById('restart').addEventListener('click', ()=>{ audio.currentTime=0; play(); });

  // ================== 단어/뜻 목록 표시 ==================
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vStNllzm5-k6fhgwTaSBEJBDPc2_18pBfSoltOuUunJKjPY-vmw75lWn2UFlRNY5uNVAMzrc3iiN-XD/pub?output=csv";

  function parseCSV(text){
    const rows = [];
    const lines = text.replace(/\ufeff/g,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
    for (const line of lines){
      if(!line.trim()) continue;
      const cells = [];
      let cell = '', inQuotes = false;
      for(let i=0;i<line.length;i++){
        const ch=line[i], next=line[i+1];
        if(inQuotes){
          if(ch === '"' && next === '"'){ cell+='"'; i++; }
          else if(ch === '"'){ inQuotes=false; }
          else cell+=ch;
        }else{
          if(ch === '"') inQuotes=true;
          else if(ch === ','){ cells.push(cell); cell=''; }
          else cell+=ch;
        }
      }
      cells.push(cell);
      rows.push(cells);
    }
    return rows;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  async function loadWordsForBook(){
    const box = document.getElementById('wordBox');
    box.innerHTML = '단어목록 로딩중..';

    try{
      const res = await fetch(SHEET_CSV_URL, {cache:'no-store'});
      const text = await res.text();
      const rows = parseCSV(text);

      // 컬럼: book_id, book_title, term, meaning (앞 4열 기준)
      const list = rows
        .filter(r => (r[0]||'').trim().toLowerCase() === qn && (r[2]||'').trim())
        .map(r => ({
          term: (r[2]||'').trim(),
          meaning: (r[3]||'').trim()
        }));

      if(!list.length){
        box.innerHTML = '<div style="color:#c62828;font-weight:900">단어목록을 찾지 못했습니다.</div>';
        return;
      }

      box.innerHTML = list.map(w => `
        <div class="wordRow">
          <div class="wordTerm">${escapeHtml(w.term)}</div>
          <div class="wordMean">${escapeHtml(w.meaning)}</div>
        </div>
      `).join('');
    }catch(e){
      box.innerHTML = '<div style="color:#c62828;font-weight:900">단어목록 로드 실패</div>';
    }
  }

  // ✅ 진입 시 자동 불러오기 + 단어목록 로드
  load();
  loadWordsForBook();
</script>
</body>
</html>



