<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WiseReader 전체 듣기</title>
  <style>
    :root{--brand:#4f8ef7;--bg:#f7f7fb;--card:#fff;--bd:#e9eef5;--tx:#222;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:22px 16px}
    .top{display:flex;flex-direction:column;gap:10px;align-items:center}
    .t1{margin:0;font-size:30px;font-weight:900}
    .t2{font-size:26px;font-weight:900;color:var(--brand);text-align:center}

    main{max-width:900px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:12px}
    button{
      padding:12px 14px;border-radius:12px;border:1px solid #d5ddea;background:#fff;
      font-weight:900;cursor:pointer;min-width:120px
    }
    select{padding:10px 12px;border-radius:10px;border:1px solid #d5ddea;font-weight:900}
    audio{width:100%;margin-top:12px}
    .status{margin-top:10px;font-size:14px;font-weight:800;text-align:center;display:none}
    .bad{color:#c62828}
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="t1">전체 듣기</div>
    <div id="bookLine" class="t2"></div>
  </div>
</header>

<main>
  <div class="card">
    <div class="row" style="margin-top:0">
      <button id="btnLoad">불러오기</button>
      <button id="btnPlay">재생</button>
      <button id="btnPause">일시정지</button>
      <button id="btnStop">정지</button>
    </div>

    <div class="row">
      <span style="font-weight:900;">속도</span>
      <select id="rate">
       
        <option value="0.9">0.9x</option>
        <option value="1.0" selected>1.0x</option>
        <option value="1.2">1.2x</option>
        <option value="1.5">1.5x</option>
      </select>

      <button id="m2">-2초</button>
      <button id="p2">+2초</button>
      <button id="restart">처음부터</button>
    </div>

    <audio id="player" controls preload="none"></audio>
    <div id="status" class="status bad"></div>

    <div class="row">
      <button onclick="location.href='menu.html'">단어학습 초기메뉴</button>
      <button onclick="goStart()">와이즈리더 시작 화면</button>
    </div>
  </div>
</main>

<script>
  const qn = sessionStorage.getItem('wr_qn') || '';
  const title = sessionStorage.getItem('wr_title') || '';
  if(!qn){ location.href='index.html'; }

  document.getElementById('bookLine').textContent =
    `${qn.toUpperCase()}  |  ${title}`;

  const audio = document.getElementById('player');
  const rateSel = document.getElementById('rate');
  const statusEl = document.getElementById('status');

  function showError(msg){
    statusEl.textContent = msg;
    statusEl.style.display = 'block';
  }
  function clearError(){
    statusEl.textContent = '';
    statusEl.style.display = 'none';
  }

  function audioUrl(){
    return `audio/${qn}.mp3?v=${Date.now()}`;
  }

  async function load(){
    clearError();
    const url = audioUrl();

    let ok = false;
    try{
      const r = await fetch(url, {method:'HEAD', cache:'no-store'});
      ok = r.ok;
    }catch(_){
      try{
        const r = await fetch(url, {method:'GET', cache:'no-store'});
        ok = r.ok;
      }catch(__){
        ok = false;
      }
    }

    if(!ok){
      showError(`mp3를 찾지 못했습니다: audio/${qn}.mp3`);
      return;
    }

    audio.src = url;
    audio.playbackRate = parseFloat(rateSel.value || "1.0");
    audio.load();
    // ✅ “불러오기 완료” 문구는 요청대로 표시하지 않음
  }

  function play(){
    clearError();
    if(!audio.src){ showError("먼저 불러오기를 누르세요."); return; }
    audio.playbackRate = parseFloat(rateSel.value || "1.0");
    audio.play().catch(()=>showError("재생이 차단되면 화면을 한번 터치 후 다시 재생하세요."));
  }

  function pause(){ audio.pause(); }
  function stop(){ audio.pause(); audio.currentTime=0; }
  function jump(sec){
    if(!audio.duration) return;
    audio.currentTime = Math.min(Math.max(0, audio.currentTime + sec), audio.duration);
  }

  document.getElementById('btnLoad').addEventListener('click', load);
  document.getElementById('btnPlay').addEventListener('click', play);
  document.getElementById('btnPause').addEventListener('click', pause);
  document.getElementById('btnStop').addEventListener('click', stop);

  rateSel.addEventListener('change', ()=>{
    audio.playbackRate = parseFloat(rateSel.value || "1.0");
  });

  document.getElementById('m2').addEventListener('click', ()=>jump(-2));
  document.getElementById('p2').addEventListener('click', ()=>jump(2));
  document.getElementById('restart').addEventListener('click', ()=>{ audio.currentTime=0; play(); });

  function goStart(){
    location.href = "dcwiseaudio.github.io/wisereader-start/index.html"; // ✅ 시작 화면 파일명/주소로 수정
  }

  // 진입 시 자동 불러오기(원하면 주석처리)
  load();
</script>
</body>
</html>


