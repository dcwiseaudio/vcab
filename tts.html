<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WiseReader ì „ì²´ ë“£ê¸°</title>
  <style>
    :root{--brand:#4f8ef7;--bg:#f7f7fb;--card:#fff;--bd:#e9eef5;--tx:#222;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);padding:10px 16px}
    .top{display:flex;flex-direction:column;gap:6px;align-items:center}
    .t1{margin:0;font-size:20px;font-weight:900}
    .t2{font-size:18px;font-weight:900;color:var(--brand);text-align:center}
    main{max-width:900px;margin:0 auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:18px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
    .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:12px}
    button{
      padding:12px 14px;border-radius:12px;border:1px solid #d5ddea;background:#fff;
      font-weight:900;cursor:pointer;min-width:110px
    }
    select{padding:10px 12px;border-radius:10px;border:1px solid #d5ddea;font-weight:900}
    audio{width:100%;margin-top:12px}
    .status{margin-top:10px;font-size:14px;font-weight:800;text-align:center}
    .ok{color:#1b5e20}
    .bad{color:#c62828}
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="t1">ğŸ§ ì „ì²´ ë“£ê¸° (mp3 ì¬ìƒ)</div>
    <div id="bookLine" class="t2"></div>
  </div>
</header>

<main>
  <div class="card">
    <div class="row" style="margin-top:0">
      <button id="btnLoad">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="btnPlay">ì¬ìƒ</button>
      <button id="btnPause">ì¼ì‹œì •ì§€</button>
      <button id="btnStop">ì •ì§€</button>
    </div>

    <div class="row">
      <span style="font-weight:900;">ì†ë„</span>
      <select id="rate">
        <option value="0.85">0.85x</option>
        <option value="0.9">0.9x</option>
        <option value="1.0" selected>1.0x</option>
        <option value="1.1">1.1x</option>
      </select>

      <button id="m2">-2ì´ˆ</button>
      <button id="p2">+2ì´ˆ</button>
      <button id="restart">ì²˜ìŒë¶€í„°</button>
    </div>

    <audio id="player" controls preload="none"></audio>
    <div id="status" class="status"></div>

    <div class="row">
      <button onclick="location.href='menu.html'">ë©”ë‰´ë¡œ</button>
    </div>
  </div>
</main>

<script>
  const qn = sessionStorage.getItem('wr_qn') || '';
  const title = sessionStorage.getItem('wr_title') || '';
  if(!qn){ location.href='index.html'; }

  document.getElementById('bookLine').textContent =
    `${qn.toUpperCase()}  |  ${title}`;

  const audio = document.getElementById('player');
  const rateSel = document.getElementById('rate');
  const statusEl = document.getElementById('status');

  function setStatus(msg, ok=true){
    statusEl.textContent = msg;
    statusEl.className = "status " + (ok ? "ok" : "bad");
  }

  function audioUrl(){
    // ìºì‹œ íšŒí”¼ (ì—…ë°ì´íŠ¸ í›„ Fullyì—ì„œ ì•ˆ ë°”ë€ŒëŠ” ë¬¸ì œ ë°©ì§€)
    return `audio/${qn}.mp3?v=${Date.now()}`;
  }

  async function load(){
    const url = audioUrl();
    setStatus("mp3 í™•ì¸ ì¤‘...", true);

    // ì„œë²„ì— ë”°ë¼ HEAD ë§‰í ìˆ˜ ìˆì–´ì„œ GET fallback
    let ok = false;
    try{
      const r = await fetch(url, {method:'HEAD', cache:'no-store'});
      ok = r.ok;
    }catch(_){
      try{
        const r = await fetch(url, {method:'GET', cache:'no-store'});
        ok = r.ok;
      }catch(__){
        ok = false;
      }
    }

    if(!ok){
      setStatus(`mp3ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: audio/${qn}.mp3`, false);
      return;
    }

    audio.src = url;
    audio.playbackRate = parseFloat(rateSel.value || "1.0");
    audio.load();
    setStatus(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ âœ… (audio/${qn}.mp3)`, true);
  }

  function play(){
    if(!audio.src){ setStatus("ë¨¼ì € ë¶ˆëŸ¬ì˜¤ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.", false); return; }
    audio.playbackRate = parseFloat(rateSel.value || "1.0");
    audio.play().catch(()=>setStatus("ì¬ìƒì´ ì°¨ë‹¨ë˜ë©´ í™”ë©´ì„ í•œë²ˆ í„°ì¹˜ í›„ ë‹¤ì‹œ ì¬ìƒí•˜ì„¸ìš”.", false));
  }

  function pause(){ audio.pause(); setStatus("ì¼ì‹œì •ì§€", true); }
  function stop(){ audio.pause(); audio.currentTime=0; setStatus("ì •ì§€", true); }
  function jump(sec){
    if(!audio.duration) return;
    audio.currentTime = Math.min(Math.max(0, audio.currentTime + sec), audio.duration);
  }

  document.getElementById('btnLoad').addEventListener('click', load);
  document.getElementById('btnPlay').addEventListener('click', play);
  document.getElementById('btnPause').addEventListener('click', pause);
  document.getElementById('btnStop').addEventListener('click', stop);

  rateSel.addEventListener('change', ()=>{
    audio.playbackRate = parseFloat(rateSel.value || "1.0");
    setStatus(`ì†ë„: ${audio.playbackRate}x`, true);
  });

  document.getElementById('m2').addEventListener('click', ()=>jump(-2));
  document.getElementById('p2').addEventListener('click', ()=>jump(2));
  document.getElementById('restart').addEventListener('click', ()=>{ audio.currentTime=0; play(); });

  // í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ë¶ˆëŸ¬ì˜¤ê¸°(ì›í•˜ë©´ ì£¼ì„ì²˜ë¦¬ ê°€ëŠ¥)
  load();
</script>
</body>
</html>

