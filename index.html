<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wisereader Vocabulary Practice</title>
<style>
  :root { --brand:#4f8ef7; --bg:#f7f7fb; --card:#fff; --border:#e9eef5; --text:#222; }
  * { box-sizing:border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  header { position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:10px 16px; z-index:5; }
  .headbar { display:flex; flex-direction:column; align-items:center; gap:6px; }
  .appTitle { margin:0; font-size:26px; font-weight:800; text-align:center; }
  .bookTitle { font-size:20px; font-weight:800; color:var(--brand); min-height:1em; text-align:center; }

  main { max-width:980px; margin:0 auto; padding:20px; }

  .intro { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:24px; box-shadow:0 6px 18px rgba(0,0,0,.05); }
  .intro h2 { margin:0 0 10px; font-size:22px; text-align:center; }
  .intro p { margin:6px 0 14px; color:#444; text-align:center; }

  .field { display:flex; justify-content:center; gap:12px; flex-wrap:wrap; }
  .big-input { flex:0 1 720px; width:100%; max-width:720px; padding:20px 18px; border:2px solid #d5ddea; border-radius:12px; font-size:32px; font-weight:700; }
  .big-input::placeholder { font-size:28px; font-weight:400; color:#99a3b3; }
  .big-btn { padding:18px 20px; border-radius:12px; border:1px solid #d5ddea; background:#fff; cursor:pointer; font-size:20px; }
  .hint { font-size:14px; color:#666; text-align:center; margin-top:8px; }
  .err { color:#c62828; margin-top:8px; font-weight:600; white-space:pre-line; text-align:center; }

  .menu-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; margin-top:16px; }
  .menu-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:22px; text-align:center; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.05); transition:transform .08s ease; }
  .menu-card:hover { transform:translateY(-2px); }
  .menu-title { font-size:20px; margin:8px 0 6px; }
  .menu-desc { color:#666; font-size:14px; }

  .tabs { display:none; align-items:center; gap:8px; flex-wrap:wrap; margin-bottom:14px; }
  .tab-btn { padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer; font-size:14px; }
  .tab-btn.active { background:var(--brand); color:#fff; border-color:transparent; }
  .back-btn { margin-left:auto; padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:#fff; cursor:pointer; }

  section.card { display:none; background:#fff; border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:0 6px 18px rgba(0,0,0,.05); }

  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px; }
  button { padding:10px 14px; border-radius:10px; border:1px solid #d5ddea; background:#fff; cursor:pointer; }
  button:disabled { opacity:.6; cursor:not-allowed; }

  .tts-btn.active { background:var(--brand); color:#fff; border-color:transparent; }

  .displayCard { font-size:26px; font-weight:800; text-align:center; padding:14px; border-radius:12px; background:#f0f5ff; border:1px solid #d9e4ff; }
  #subInfo { text-align:center; color:#555; margin-top:6px; }

  #quiz .option { display:block; margin:8px 0; padding:12px; border:1px solid #d5ddea; border-radius:10px; background:#fafcff; cursor:pointer; text-align:left; }
  #quiz .badge { float:right; font-weight:700; }
  .correct { background:#d9f8d7 !important; border-color:#97e493 !important; }
  .wrong { background:#fde1e1 !important; border-color:#f2a5a5 !important; }
  #quizStatus { margin-top:8px; font-size:14px; color:#555; }

  .overlay {
    position:fixed; inset:0;
    background:rgba(0,0,0,.25);
    display:none;
    z-index:20;
  }
  .overlay.show { display:block; }
  .picker {
    position:fixed; inset:0;
    display:none;
    z-index:21;
  }
  .picker.show { display:flex; justify-content:center; align-items:center; }
  .picker-panel {
    width:90%; max-width:600px; max-height:80vh;
    background:#fff; border-radius:14px;
    box-shadow:0 12px 30px rgba(0,0,0,.2);
    display:flex; flex-direction:column;
    overflow:hidden;
  }
  .picker-header {
    padding:12px 16px;
    border-bottom:1px solid var(--border);
    display:flex; align-items:center; gap:8px;
  }
  .picker-header h3 { margin:0; font-size:18px; }
  .picker-body {
    padding:8px 12px;
    overflow:auto;
    flex:1 1 auto;
  }
  .word-item {
    padding:8px 6px;
    border-bottom:1px solid #f1f4fa;
    display:flex;
    align-items:flex-start;
    gap:8px;
  }
  .word-check { margin-top:4px; }
  .word-main { flex:1; }
  .word-term { font-weight:700; font-size:15px; }
  .word-meaning { font-size:13px; color:#555; }
  .picker-footer {
    padding:10px 16px;
    border-top:1px solid var(--border);
    display:flex; justify-content:space-between; align-items:center;
    font-size:13px; color:#555;
  }
  .picker-footer button {
    padding:8px 12px;
    border-radius:8px;
  }
</style>
</head>

<body>
<header>
  <div class="headbar">
    <h1 class="appTitle">Wisereader Vocabulary Practice</h1>
    <div id="bookTitle" class="bookTitle"></div>
  </div>
</header>

<main>
  <!-- ì²« í™”ë©´: QN ì…ë ¥ -->
  <section id="intro" class="intro" style="display:block;">
    <h2>Wisereader ë‹¨ì–´ í•™ìŠµì„ ì‹œì‘í•©ë‹ˆë‹¤</h2>
    <p>ì˜¤ëŠ˜ í•™ìŠµí•  ì±…ì˜ <b>QN</b>ë¥¼ ë„£ì–´ì£¼ì„¸ìš”.</p>
    <div class="field">
      <input id="qnInput" class="big-input" type="text"
             placeholder="ì˜ˆ: N2300, A1136, AB300 â€¦"
             onkeydown="if(event.key==='Enter') startWithQN()">
      <button class="big-btn" onclick="startWithQN()">ì‹œì‘í•˜ê¸° â–¶</button>
    </div>
    <div class="hint">ì…ë ¥ í›„ ì‹œì‘í•˜ê¸°ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
    <div id="introError" class="err" style="display:none;"></div>
  </section>

  <!-- ë©”ë‰´ í™”ë©´ -->
  <div id="landing" style="display:none;">
    <div class="menu-grid">
      <div class="menu-card" onclick="openSection('tts')">
        <div style="font-size:36px">ğŸ”Š</div>
        <div class="menu-title">ë°œìŒë“£ê¸°</div>
        <div class="menu-desc">ë‹¨ì–´ë¥¼ ì˜ì–´ ìŒì„±ìœ¼ë¡œ ìˆœì„œëŒ€ë¡œ ë“¤ë ¤ì¤˜ìš”</div>
      </div>
      <div class="menu-card" onclick="openSection('quiz')">
        <div style="font-size:36px">â“</div>
        <div class="menu-title">ê°ê´€ì‹ í€´ì¦ˆ</div>
        <div class="menu-desc">ë³´ê¸° ì¤‘ì—ì„œ ëœ»ì„ ê³ ë¥´ëŠ” ì—°ìŠµ</div>
      </div>
    </div>
  </div>

  <!-- ìƒë‹¨ íƒ­ -->
  <div id="tabs" class="tabs">
    <button class="tab-btn" id="tab-tts" onclick="openSection('tts')">ğŸ”Š ë°œìŒë“£ê¸°</button>
    <button class="tab-btn" id="tab-quiz" onclick="openSection('quiz')">â“ ê°ê´€ì‹ í€´ì¦ˆ</button>
    <button class="back-btn" onclick="goHome()">ì²˜ìŒìœ¼ë¡œ</button>
  </div>

  <!-- ë°œìŒë“£ê¸° -->
  <section id="sec-tts" class="card">
    <h3>ğŸ”Š ë°œìŒë“£ê¸°</h3>
    <div id="nowPlaying" class="displayCard">ì„¸íŠ¸ë¥¼ ì…ë ¥í•˜ê³  ì‹œì‘í•˜ì„¸ìš”</div>
    <div id="subInfo"></div>
    <div class="row">
      <button id="btnAll" class="tts-btn" onclick="playAll()">ì „ì²´ ë“¤ìœ¼ë©´ì„œ ë”°ë¼ ë§í•˜ê¸° â–¶â–¶</button>
      <button id="btnRepeat" class="tts-btn" onclick="openRepeatPicker()">ì„ íƒí˜• ë°˜ë³µë“£ê¸° ğŸ”</button>
      <button id="btnStop" class="tts-btn" onclick="stopSpeaking()">ì •ì§€ â¹</button>
    </div>
  </section>

  <!-- ê°ê´€ì‹ í€´ì¦ˆ -->
  <section id="sec-quiz" class="card">
    <h3>â“ ê°ê´€ì‹ í€´ì¦ˆ</h3>
    <div id="quiz"></div>
    <div id="quizStatus"></div>
    <div class="row">
      <button id="nextBtn" onclick="nextQuiz()" disabled>ë‹¤ìŒ ë¬¸ì œ â–¶</button>
      <button onclick="resetSet()">ìƒˆ ì„¸íŠ¸ ì‹œì‘ ğŸ”</button>
    </div>
  </section>
</main>

<!-- ì„ íƒí˜• ë°˜ë³µë“£ê¸° ì˜¤ë²„ë ˆì´ -->
<div id="overlay" class="overlay"></div>
<div id="repeatPicker" class="picker" aria-hidden="true">
  <div class="picker-panel">
    <div class="picker-header">
      <h3>ë°˜ë³µí•  ë‹¨ì–´ ì„ íƒ (1â€“30ê°œ)</h3>
      <div style="flex:1"></div>
      <button onclick="closeRepeatPicker()">ë‹«ê¸° âœ•</button>
    </div>
    <div class="picker-body" id="repeatList"></div>
    <div class="picker-footer">
      <span id="repeatCountLabel">ì„ íƒ: 0ê°œ</span>
      <div style="display:flex; gap:8px;">
        <button onclick="clearRepeatSelection()">ëª¨ë‘ í•´ì œ</button>
        <button onclick="startRepeatFromSelection()">ì„ íƒí•œ ë‹¨ì–´ ë°˜ë³µ ë“£ê¸° â–¶</button>
      </div>
    </div>
  </div>
</div>

<script>
// ================== ì„¤ì • ==================
const SHEET_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vStNllzm5-k6fhgwTaSBEJBDPc2_18pBfSoltOuUunJKjPY-vmw75lWn2UFlRNY5uNVAMzrc3iiN-XD/pub?gid=0&single=true&output=csv";

// ================== ìœ í‹¸ ==================
function $(id){ return document.getElementById(id); }

function showError(msg){
  const err = $('introError');
  err.textContent = msg;
  err.style.display = 'block';
}
function clearError(){
  const err = $('introError');
  err.textContent = '';
  err.style.display = 'none';
}
function showIntro(){
  $('intro').style.display = 'block';
  $('landing').style.display = 'none';
  $('tabs').style.display = 'none';
  ['tts','quiz'].forEach(id => $('sec-'+id).style.display = 'none');
}
function showLanding(){
  $('intro').style.display = 'none';
  $('landing').style.display = 'block';
  $('tabs').style.display = 'none';
  ['tts','quiz'].forEach(id => $('sec-'+id).style.display = 'none');
}
function showSection(which){
  $('landing').style.display = 'none';
  $('tabs').style.display = 'flex';
  ['tts','quiz'].forEach(id=>{
    $('sec-'+id).style.display = (id===which)?'block':'none';
    $('tab-'+id).classList.toggle('active', id===which);
  });
}

// ================== CSV íŒŒì„œ ==================
function parseCSV(text) {
  const rows = [];
  const lines = text
    .replace(/\ufeff/g,'')
    .replace(/\r\n/g,'\n')
    .replace(/\r/g,'\n')
    .split('\n');

  for (let line of lines) {
    if (!line.trim()) continue;
    const cells = [];
    let cell = '';
    let inQuotes = false;

    for (let i=0; i<line.length; i++) {
      const ch = line[i];
      const next = line[i+1];

      if (inQuotes) {
        if (ch === '"' && next === '"') { cell += '"'; i++; }
        else if (ch === '"') { inQuotes = false; }
        else { cell += ch; }
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ',') { cells.push(cell); cell = ''; }
        else { cell += ch; }
      }
    }
    cells.push(cell);
    rows.push(cells);
  }
  return rows;
}

// ================== ìŒì„± ==================
const VOICE_PRIORITY = [
  'Google US English','Google UK English Female','Google UK English Male',
  'Samantha','Karen','Daniel',
  'Microsoft Aria Online (Natural) - English (United States)',
  'Microsoft Guy Online (Natural) - English (United States)'
];
let preferredVoice = null;
let speechPrimed = false;

function pickBestVoice(){
  const voices = speechSynthesis.getVoices();
  const en = voices.filter(v => /^en(-|_)/i.test(v.lang));
  for (const name of VOICE_PRIORITY) {
    const found = en.find(v => v.name === name);
    if (found) return found;
  }
  return en[0] || voices[0] || null;
}
function ensureVoiceReady(cb){
  const tryPick = () => {
    preferredVoice = pickBestVoice();
    if (preferredVoice) cb();
  };
  if (speechSynthesis.getVoices().length) tryPick();
  else speechSynthesis.onvoiceschanged = tryPick;
}
async function primeSpeechOnce(){
  if (speechPrimed) return;
  return new Promise(resolve=>{
    try{
      speechSynthesis.resume?.();
      const u = new SpeechSynthesisUtterance(' ');
      u.lang  = 'en-US';
      u.rate  = 1.0;
      u.volume = 0.0;
      if (preferredVoice) u.voice = preferredVoice;
      u.onend = ()=>{ speechPrimed = true; resolve(); };
      u.onerror = ()=>{ speechPrimed = true; resolve(); };
      speechSynthesis.speak(u);
    }catch(_){ resolve(); }
  });
}
async function speakAsync(text, rate = 1.0) {
  try { speechSynthesis.cancel(); } catch(_) {}
  await new Promise(r=>setTimeout(r,120));
  await new Promise(resolve=>{
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang  = 'en-US';
      u.rate  = rate;
      u.pitch = 1.0;
      if (preferredVoice) u.voice = preferredVoice;
      u.onend = resolve; u.onerror = resolve;
      speechSynthesis.speak(u);
    }catch(_) { resolve(); }
  });
}

// ================== ìƒíƒœ ==================
let todaySet = [];        // {term, meaning}[]
let todayBookTitle = "";
let todayBookId = null;

let mode = 'idle';        // 'idle' | 'all' | 'repeat'
let selectedRepeat = [];  // ë°˜ë³µë“£ê¸° ëŒ€ìƒ ë°°ì—´
let remaining = [];       // í€´ì¦ˆìš©
let currentTarget = null;
let currentAnswered = false;

// ================== ê³µí†µ UI ==================
function clearTTSActive(){
  document.querySelectorAll('.tts-btn').forEach(b=>b.classList.remove('active'));
}
function setTTSActive(id){
  clearTTSActive();
  if (id) $(id).classList.add('active');
}
function showWordFromSet(w){
  const idx = todaySet.indexOf(w);
  $('nowPlaying').textContent = `${w.term} â€” ${w.meaning}`;
  $('subInfo').textContent = `(${idx+1}/${todaySet.length})`;
}
function stopSpeaking(){
  try { if (window.speechSynthesis && speechSynthesis.cancel) speechSynthesis.cancel(); } catch(_){}
  mode='idle';
  setTTSActive('btnStop');
}

// ================== í™”ë©´ ì „í™˜ ì´ë²¤íŠ¸ ==================
function openSection(which){
  stopSpeaking();
  showSection(which);
  if (which==='quiz') {
    initSet();
    nextQuiz();
  }
}
function goHome(){
  stopSpeaking();
  $('bookTitle').textContent = '';
  showIntro();
}

// ================== ì „ì²´ ë“£ê¸° ==================
async function playAll(){
  if (!todaySet.length) return;
  stopSpeaking();
  ensureVoiceReady(()=>{});
  await primeSpeechOnce();
  mode='all';
  setTTSActive('btnAll');

  for (let i=0;i<todaySet.length && mode==='all'; i++){
    const w = todaySet[i];
    showWordFromSet(w);
    await speakAsync(w.term, 0.7);
    for (let t=0;t<12 && mode==='all'; t++) await new Promise(r=>setTimeout(r,100));
  }
  mode='idle';
}

// ================== ì„ íƒí˜• ë°˜ë³µë“£ê¸° ==================
function openRepeatPicker(){
  if (!todaySet.length) { alert("ë¨¼ì € QNì„ ì…ë ¥í•´ ì„¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”."); return; }
  stopSpeaking();
  renderRepeatList();
  $('overlay').classList.add('show');
  $('repeatPicker').classList.add('show');
}
function closeRepeatPicker(){
  $('overlay').classList.remove('show');
  $('repeatPicker').classList.remove('show');
}
function renderRepeatList(){
  const list = $('repeatList');
  list.innerHTML = '';
  todaySet.forEach((w, idx)=>{
    const row = document.createElement('div');
    row.className = 'word-item';

    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.className = 'word-check';
    checkbox.dataset.index = idx;
    checkbox.onchange = updateRepeatCount;

    const main = document.createElement('div');
    main.className = 'word-main';
    const t = document.createElement('div');
    t.className = 'word-term';
    t.textContent = w.term;
    const m = document.createElement('div');
    m.className = 'word-meaning';
    m.textContent = w.meaning;

    main.appendChild(t);
    main.appendChild(m);
    row.appendChild(checkbox);
    row.appendChild(main);
    list.appendChild(row);
  });
  updateRepeatCount();
}
function updateRepeatCount(){
  const checks = document.querySelectorAll('.word-check');
  let count = 0;
  checks.forEach(c=>{ if(c.checked) count++; });
  $('repeatCountLabel').textContent = `ì„ íƒ: ${count}ê°œ`;
}
function clearRepeatSelection(){
  document.querySelectorAll('.word-check').forEach(c=>c.checked=false);
  updateRepeatCount();
}
async function startRepeatFromSelection(){
  const checks = Array.from(document.querySelectorAll('.word-check'));
  const selectedIdx = checks.filter(c=>c.checked).map(c=>parseInt(c.dataset.index,10));
  if (selectedIdx.length === 0) { alert("ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
  if (selectedIdx.length > 30) { alert("ìµœëŒ€ 30ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."); return; }

  selectedRepeat = selectedIdx.map(i => todaySet[i]);

  closeRepeatPicker();
  stopSpeaking();
  ensureVoiceReady(()=>{});
  await primeSpeechOnce();
  mode='repeat';
  setTTSActive('btnRepeat');

  while (mode === 'repeat' && selectedRepeat.length > 0) {
    for (let i=0; i<selectedRepeat.length && mode === 'repeat'; i++) {
      const w = selectedRepeat[i];
      showWordFromSet(w);
      await speakAsync(w.term, 0.8);
      for (let t=0; t<12 && mode==='repeat'; t++) await new Promise(r=>setTimeout(r,100));
    }
  }
}

// ================== í€´ì¦ˆ ==================
function initSet(){
  remaining = todaySet.slice();
  updateStatus();
}
function resetSet(){
  initSet();
  nextQuiz();
}
function completeSession(){
  $('quiz').innerHTML = '<h3>ìˆ˜ê³ í–ˆì–´ìš”! ì´ë²ˆ ì„¸íŠ¸ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ğŸ</h3>';
  $('nextBtn').disabled = true;
  updateStatus();
}
function nextQuiz(){
  const quizDiv = $('quiz');
  quizDiv.innerHTML = '';
  $('nextBtn').disabled = true;
  currentAnswered = false;

  if (!remaining || remaining.length === 0) return completeSession();

  currentTarget = remaining[Math.floor(Math.random()*remaining.length)];
  const wrongs = todaySet.filter(w=>w!==currentTarget).map(w=>w.meaning);
  shuffle(wrongs);
  const options = [currentTarget.meaning, ...wrongs.slice(0,3)];
  shuffle(options);

  const q = document.createElement('h3');
  q.textContent = `"${currentTarget.term}"ì˜ ëœ»ì€?`;
  quizDiv.appendChild(q);

  options.forEach(opt=>{
    const btn = document.createElement('button');
    btn.className = 'option';
    btn.textContent = opt;
    btn.onclick = ()=>onOptionClick(btn,opt);
    quizDiv.appendChild(btn);
  });
  updateStatus();
}
function onOptionClick(btn,opt){
  if (currentAnswered && opt !== currentTarget.meaning) return;

  if (opt === currentTarget.meaning) {
    btn.classList.add('correct');
    addBadge(btn,'â­•');
    stopSpeaking();
    try {
      const u = new SpeechSynthesisUtterance(currentTarget.term);
      u.lang  = 'en-US';
      u.rate  = 1.0;
      u.pitch = 1.0;
      if (preferredVoice) u.voice = preferredVoice;
      speechSynthesis.speak(u);
    } catch(_) {}
    currentAnswered = true;
    remaining = remaining.filter(w=>w!==currentTarget);
    updateStatus();
    $('nextBtn').disabled = false;
    if (remaining.length === 0) setTimeout(completeSession, 300);
  } else {
    btn.classList.add('wrong');
    addBadge(btn,'âœ–');
    btn.disabled = true;
  }
}
function addBadge(btn,symbol){
  let b = btn.querySelector('.badge');
  if (!b) {
    b = document.createElement('span');
    b.className = 'badge';
    btn.appendChild(b);
  }
  b.textContent = symbol;
}
function updateStatus(){
  $('quizStatus').textContent = remaining
    ? `ë‚¨ì€ ë‹¨ì–´: ${remaining.length}ê°œ / ì „ì²´ ${todaySet.length}ê°œ`
    : '';
}
function shuffle(a){
  for(let i=a.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
}

// ================== ì‹œíŠ¸ ë¡œë”© ==================
async function loadFromSheet(bookIdLower){
  todayBookId = bookIdLower;
  clearError();

  try {
    const res = await fetch(SHEET_CSV_URL, { cache:'no-store' });
    if (!res.ok) { showError("CSV ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤ (HTTP " + res.status + ")"); return false; }

    const text = await res.text();
    if (text.startsWith('<!DOCTYPE html') || text.startsWith('<html')) {
      showError("CSV ëŒ€ì‹  HTMLì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. 'ì›¹ì— ê²Œì‹œ' ë§í¬ë¥¼ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.");
      return false;
    }

    const rows = parseCSV(text);
    if (!rows.length) { showError("CSV ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤."); return false; }

    const data = rows
      .filter(cols => cols.length >= 4)
      .map(cols => ({
        book_id:    (cols[0] || '').trim(),
        book_title: (cols[1] || '').trim(),
        term:       (cols[2] || '').trim(),
        meaning:    (cols[3] || '').trim()
      }))
      .filter(r => r.book_id && r.book_id.toLowerCase() === todayBookId && r.term);

    if (!data.length) { showError("í•´ë‹¹ QN(book_id)ë¡œ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); return false; }

    todayBookTitle = data[0].book_title || data[0].book_id;
    todaySet = data.map(r => ({ term:r.term, meaning:r.meaning }));
    $('bookTitle').textContent = todayBookTitle;

    return true;
  } catch(e) {
    showError("ë„¤íŠ¸ì›Œí¬/íŒŒì‹± ì˜¤ë¥˜: " + String(e));
    return false;
  }
}

// ================== ì‹œì‘ íë¦„ ==================
async function startWithQN(){
  const qnRaw = ($('qnInput').value || '').trim();
  clearError();

  if (!qnRaw) { showError("QN(ì±… ì½”ë“œ)ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }

  const bookIdPattern = /^(?:[A-Za-z][0-9]{4}|[A-Za-z]{2}[0-9]{3})$/;
  if (!bookIdPattern.test(qnRaw)) {
    showError("QN í˜•ì‹: ì•ŒíŒŒë²³ 1~2ê¸€ì + ìˆ«ìë¡œ ì´ 5ê¸€ìì…ë‹ˆë‹¤.\nì˜ˆ: N2300, AB300");
    return;
  }

  const qn = qnRaw.toLowerCase();
  const ok = await loadFromSheet(qn);
  if (!ok) return;

  showWordFromSet(todaySet[0]);
  ensureVoiceReady(()=>{});
alert('showLanding ì§ì „');
showLanding();
alert('showLanding ì§í›„');
}

// ================== ì´ˆê¸°í™” ==================
(function init(){
  $('bookTitle').textContent = "";
  showIntro();
})();
</script>
</body>
</html>

