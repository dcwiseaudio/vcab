<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Wisereader - QN 입력</title>
<style>
  :root { --brand:#4f8ef7; --bg:#f7f7fb; --card:#fff; --border:#e9eef5; --text:#222; }
  * { box-sizing:border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  header { position:sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding:10px 16px; }
  .headbar { display:flex; flex-direction:column; align-items:center; gap:6px; }
  .appTitle { margin:0; font-size:26px; font-weight:800; text-align:center; }
  main { max-width:980px; margin:0 auto; padding:20px; }
  .intro { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:24px; box-shadow:0 6px 18px rgba(0,0,0,.05); }
  .intro h2 { margin:0 0 10px; font-size:22px; text-align:center; }
  .intro p { margin:6px 0 14px; color:#444; text-align:center; }
  .field { display:flex; justify-content:center; gap:12px; flex-wrap:wrap; }
  .big-input { flex:0 1 720px; width:100%; max-width:720px; padding:20px 18px; border:2px solid #d5ddea; border-radius:12px; font-size:32px; font-weight:700; }
  .big-btn { padding:18px 20px; border-radius:12px; border:1px solid #d5ddea; background:#fff; cursor:pointer; font-size:20px; }
  .hint { font-size:14px; color:#666; text-align:center; margin-top:8px; }
  .err { display:none; color:#c62828; margin-top:10px; font-weight:700; white-space:pre-line; text-align:center; }
</style>
</head>
<body>
<header>
  <div class="headbar">
    <h1 class="appTitle">Wisereader Vocabulary Practice</h1>
  </div>
</header>

<main>
  <section class="intro">
    <h2>단어 학습을 시작합니다</h2>
    <p>오늘 학습할 책의 <b>QN</b>를 입력하세요.</p>
    <div class="field">
      <input id="qnInput" class="big-input" type="text"
             placeholder="예: N2300, A1136, AB300 …"
             autocomplete="off"
             onkeydown="if(event.key==='Enter') startWithQN()">
      <button class="big-btn" onclick="startWithQN()">시작하기 ▶</button>
    </div>
    <div class="hint">입력 후 시작하기를 누르세요.</div>
    <div id="introError" class="err"></div>
  </section>
</main>

<script>
const SHEET_CSV_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vStNllzm5-k6fhgwTaSBEJBDPc2_18pBfSoltOuUunJKjPY-vmw75lWn2UFlRNY5uNVAMzrc3iiN-XD/pub?gid=0&single=true&output=csv";

function showErr(msg){
  const el = document.getElementById('introError');
  el.textContent = msg;
  el.style.display = 'block';
}
function clearErr(){
  const el = document.getElementById('introError');
  el.textContent = '';
  el.style.display = 'none';
}

function parseCSV(text) {
  const rows = [];
  const lines = text.replace(/\ufeff/g,'').replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
  for (let line of lines) {
    if (!line.trim()) continue;
    const cells = [];
    let cell = '';
    let inQuotes = false;
    for (let i=0; i<line.length; i++) {
      const ch = line[i];
      const next = line[i+1];
      if (inQuotes) {
        if (ch === '"' && next === '"') { cell += '"'; i++; }
        else if (ch === '"') { inQuotes = false; }
        else { cell += ch; }
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ',') { cells.push(cell); cell=''; }
        else cell += ch;
      }
    }
    cells.push(cell);
    rows.push(cells);
  }
  return rows;
}

async function validateQNAndGetTitle(qnLower){
  const res = await fetch(SHEET_CSV_URL, { cache:'no-store' });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const text = await res.text();
  if (text.startsWith('<!DOCTYPE html') || text.startsWith('<html')) {
    throw new Error('CSV 대신 HTML이 반환됨');
  }
  const rows = parseCSV(text);
  const data = rows
    .filter(cols => cols.length >= 4)
    .map(cols => ({
      book_id: (cols[0]||'').trim().toLowerCase(),
      book_title: (cols[1]||'').trim(),
    }))
    .filter(r => r.book_id === qnLower);

  if (!data.length) return null;
  return data[0].book_title || qnLower.toUpperCase();
}

async function startWithQN(){
  clearErr();
  const raw = (document.getElementById('qnInput').value||'').trim();
  if (!raw) { showErr("QN(책 코드)을 입력해 주세요."); return; }

  const bookIdPattern = /^(?:[A-Za-z][0-9]{4}|[A-Za-z]{2}[0-9]{3})$/;
  if (!bookIdPattern.test(raw)) {
    showErr("QN 형식: 알파벳 1~2글자 + 숫자로 총 5글자입니다.\n예: N2300, AB300");
    return;
  }

  const qn = raw.toLowerCase();
  try {
    const title = await validateQNAndGetTitle(qn);
    if (!title) { showErr("해당 QN(book_id)로 데이터를 찾지 못했습니다."); return; }

    // 다음 페이지로 넘길 최소 정보 저장
    sessionStorage.setItem('wr_qn', qn);
    sessionStorage.setItem('wr_title', title);

    // ✅ 페이지 이동 (Fully에서 가장 안정)
    location.href = `menu.html?qn=${encodeURIComponent(qn)}`;
  } catch(e) {
    showErr("데이터 로드 오류: " + String(e));
  }
}
</script>
</body>
</html>

